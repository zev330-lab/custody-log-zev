<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="CustodyLog">
<meta name="theme-color" content="#0f1117">
<meta name="description" content="Private custody documentation ‚Äî incidents and positive moments">
<link rel="manifest" href="manifest.json">
<link rel="icon" type="image/png" href="icon-192.png">
<link rel="apple-touch-icon" href="icon-192.png">
<title>CustodyLog</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap');
:root {
  --bg:#0f1117;--s1:#1a1d27;--s2:#232733;--s3:#2a2e3b;
  --bdr:#2d3140;--tx:#e8e9ed;--tx2:#c0c3cf;--mt:#6b7089;
  --ac:#4a9eff;--acd:rgba(74,158,255,.12);--acb:rgba(74,158,255,.3);
  --rd:#ff6b6b;--rdd:rgba(255,107,107,.12);--rdb:rgba(255,107,107,.3);
  --gn:#51cf96;--gnd:rgba(81,207,150,.12);--gnb:rgba(81,207,150,.3);
  --yw:#ffc145;--ywd:rgba(255,193,69,.12);--ywb:rgba(255,193,69,.3);
  --r:12px;--rs:8px;
  --sat:env(safe-area-inset-top,0px);
  --sab:env(safe-area-inset-bottom,0px);
  --sal:env(safe-area-inset-left,0px);
  --sar:env(safe-area-inset-right,0px);
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:'DM Sans',-apple-system,BlinkMacSystemFont,sans-serif;background:var(--bg);color:var(--tx);min-height:100vh;min-height:100dvh;overflow-x:hidden;-webkit-font-smoothing:antialiased}
input,textarea,select,button{font-family:inherit}

@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes slideRight{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
@keyframes slideLeft{from{transform:translateX(-100%);opacity:0}to{transform:translateX(0);opacity:1}}
@keyframes slideUp{from{transform:translateY(16px);opacity:0}to{transform:translateY(0);opacity:1}}
@keyframes shake{0%,100%{transform:translateX(0)}20%,60%{transform:translateX(-8px)}40%,80%{transform:translateX(8px)}}
.fadeIn{animation:fadeIn .25s ease}
.slideRight{animation:slideRight .3s ease}
.slideLeft{animation:slideLeft .3s ease}
.slideUp{animation:slideUp .25s ease}
.shake{animation:shake .4s ease}

.pin-wrap{min-height:100vh;min-height:100dvh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:calc(40px + var(--sat)) 24px calc(40px + var(--sab));text-align:center}
.pin-logo{font-size:56px;margin-bottom:16px}
.pin-wrap h1{font-size:22px;font-weight:700;margin-bottom:6px}
.pin-wrap .sub{color:var(--mt);font-size:14px;margin-bottom:32px;max-width:260px}
.pin-dots{display:flex;gap:12px;margin-bottom:32px;justify-content:center}
.pin-dot{width:16px;height:16px;border-radius:50%;border:2px solid var(--bdr);background:transparent;transition:all .15s}
.pin-dot.filled{background:var(--ac);border-color:var(--ac)}
.pin-dot.error{background:var(--rd);border-color:var(--rd)}
.pin-pad{display:grid;grid-template-columns:repeat(3,72px);gap:12px;justify-content:center}
.pin-key{width:72px;height:72px;border-radius:50%;border:1px solid var(--bdr);background:var(--s1);color:var(--tx);font-size:24px;font-weight:600;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .1s;-webkit-user-select:none;user-select:none}
.pin-key:active{background:var(--s3);transform:scale(.93)}
.pin-key.empty{border:none;background:transparent}
.pin-key.fn{font-size:14px;color:var(--mt);border:none;background:transparent}
.pin-key.fn:active{color:var(--tx)}
.pin-msg{margin-top:16px;font-size:13px;color:var(--rd);min-height:20px}
.pin-skip{margin-top:20px;color:var(--mt);font-size:13px;background:none;border:none;cursor:pointer;text-decoration:underline}

.header{position:sticky;top:0;z-index:100;background:rgba(15,17,23,.88);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-bottom:1px solid var(--bdr);padding:calc(14px + var(--sat)) calc(20px + var(--sar)) 14px calc(20px + var(--sal));display:flex;align-items:center;justify-content:space-between}
.header h1{font-size:17px;font-weight:700;display:flex;align-items:center;gap:8px}
.header h1 span{font-size:20px}
.hdr-btns{display:flex;gap:8px}
.ibtn{width:38px;height:38px;border-radius:var(--rs);border:1px solid var(--bdr);background:var(--s1);color:var(--mt);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:16px;transition:all .15s}
.ibtn:active{transform:scale(.93);background:var(--s2)}

.tabs{display:flex;gap:4px;padding:10px calc(20px + var(--sar)) 10px calc(20px + var(--sal));background:var(--bg);border-bottom:1px solid var(--bdr);position:sticky;top:calc(67px + var(--sat));z-index:99}
.tab{flex:1;padding:10px 4px;border-radius:var(--rs);border:none;background:transparent;color:var(--mt);font-size:13px;font-weight:600;cursor:pointer;transition:all .15s;text-align:center}
.tab.on{background:var(--acd);color:var(--ac)}
.tab:active{transform:scale(.97)}

.content{padding:16px calc(20px + var(--sar)) calc(120px + var(--sab)) calc(20px + var(--sal))}

.grp-label{font-size:11px;font-weight:700;letter-spacing:1.2px;text-transform:uppercase;color:var(--mt);margin:18px 0 8px;display:flex;align-items:center;gap:6px}
.grp-label:first-child{margin-top:4px}
.cat-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.cat-btn{padding:14px 12px;border-radius:var(--r);border:1px solid var(--bdr);background:var(--s1);color:var(--tx);font-size:13px;font-weight:500;cursor:pointer;transition:all .15s;display:flex;align-items:center;gap:9px;text-align:left;line-height:1.3}
.cat-btn .ci{font-size:20px;flex-shrink:0}
.cat-btn:active{transform:scale(.97);background:var(--s2)}

.type-switch{display:flex;gap:8px;margin-bottom:18px}
.type-btn{flex:1;padding:16px 12px;border-radius:var(--r);border:2px solid var(--bdr);background:var(--s1);color:var(--mt);font-size:14px;font-weight:600;cursor:pointer;transition:all .15s;text-align:center;line-height:1.4}
.type-btn:active{transform:scale(.97)}
.type-btn .ti{font-size:24px;display:block;margin-bottom:6px}
.type-btn.t-incident.on{border-color:var(--ywb);color:var(--yw);background:var(--ywd)}
.type-btn.t-positive.on{border-color:var(--gnb);color:var(--gn);background:var(--gnd)}

.form-page{max-width:500px;margin:0 auto}
.back-bar{display:flex;align-items:center;gap:10px;padding:4px 0 16px;cursor:pointer}
.back-bar .arrow{font-size:20px;color:var(--ac)}
.back-bar .cat-tag{font-size:14px;font-weight:600;display:flex;align-items:center;gap:6px}
.flabel{display:block;font-size:11px;font-weight:700;color:var(--mt);margin-bottom:6px;text-transform:uppercase;letter-spacing:.8px}
.fgroup{margin-bottom:16px}
.finput,.ftextarea,.fselect{width:100%;padding:13px 15px;border-radius:var(--r);border:1px solid var(--bdr);background:var(--s1);color:var(--tx);font-size:16px;outline:none;transition:border-color .15s;-webkit-appearance:none}
.finput:focus,.ftextarea:focus{border-color:var(--ac)}
.ftextarea{min-height:130px;resize:vertical;line-height:1.5;font-size:15px}
.finput::placeholder,.ftextarea::placeholder{color:var(--mt);opacity:.5}
input[type="date"],input[type="time"]{color-scheme:dark}
.row{display:flex;gap:8px}
.row>*{flex:1}

.sev-row{display:flex;gap:7px}
.sev-btn{flex:1;padding:10px 4px;border-radius:var(--rs);border:1px solid var(--bdr);background:var(--s1);font-size:12px;font-weight:600;cursor:pointer;text-align:center;transition:all .15s;color:var(--mt)}
.sev-btn:active{transform:scale(.96)}
.sev-btn.s-low{border-color:var(--gn);color:var(--gn);background:var(--gnd)}
.sev-btn.s-medium{border-color:var(--yw);color:var(--yw);background:var(--ywd)}
.sev-btn.s-high{border-color:var(--rd);color:var(--rd);background:var(--rdd)}
.sev-btn.s-critical{border-color:#ff3b3b;color:#ff3b3b;background:rgba(255,59,59,.15)}

.chk-row{display:flex;align-items:center;gap:10px;padding:12px 0;cursor:pointer;-webkit-user-select:none;user-select:none}
.chk-row input{width:22px;height:22px;accent-color:var(--ac);cursor:pointer;flex-shrink:0}
.chk-row label{font-size:14px;cursor:pointer}

.media-section{margin-bottom:16px}
.media-btns{display:flex;gap:8px;flex-wrap:wrap}
.media-btn{padding:10px 16px;border-radius:var(--r);border:1px solid var(--bdr);background:var(--s1);color:var(--tx2);font-size:13px;font-weight:500;cursor:pointer;display:flex;align-items:center;gap:6px;transition:all .15s}
.media-btn:active{transform:scale(.96);background:var(--s2)}
.media-btn .mi{font-size:18px}
.media-list{margin-top:10px;display:flex;flex-direction:column;gap:8px}
.media-item{display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--s2);border-radius:var(--rs);border:1px solid var(--bdr)}
.media-item .mthumb{width:48px;height:48px;border-radius:6px;object-fit:cover;background:var(--s3);flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:22px;overflow:hidden}
.media-item .mthumb img{width:100%;height:100%;object-fit:cover}
.media-item .minfo{flex:1;min-width:0}
.media-item .mname{font-size:13px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.media-item .msize{font-size:11px;color:var(--mt)}
.media-item .mrem{width:32px;height:32px;border-radius:50%;border:none;background:var(--rdd);color:var(--rd);font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.media-item .mrem:active{transform:scale(.9)}

.pbtn{width:100%;padding:16px;border-radius:var(--r);border:none;background:var(--ac);color:#fff;font-size:16px;font-weight:700;cursor:pointer;transition:all .15s;letter-spacing:.3px}
.pbtn:active{transform:scale(.98);opacity:.9}
.pbtn:disabled{opacity:.35;cursor:not-allowed}
.pbtn.pbtn-gn{background:var(--gn)}
.sbtn{width:100%;padding:14px;border-radius:var(--r);border:1px solid var(--bdr);background:var(--s1);color:var(--tx);font-size:15px;font-weight:600;cursor:pointer;margin-top:10px;transition:all .15s}
.sbtn:active{transform:scale(.98)}

.ecard{background:var(--s1);border:1px solid var(--bdr);border-radius:var(--r);padding:14px 16px;margin-bottom:10px;cursor:pointer;transition:all .15s;animation:slideUp .25s ease}
.ecard:active{background:var(--s2)}
.ecard.ecard-pos{border-color:rgba(81,207,150,.25)}
.ehead{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:6px}
.ecat{font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;display:flex;align-items:center;gap:5px}
.esev{font-size:10px;font-weight:700;padding:3px 8px;border-radius:20px;text-transform:uppercase;letter-spacing:.7px}
.esev.sev-low{background:var(--gnd);color:var(--gn)}
.esev.sev-medium{background:var(--ywd);color:var(--yw)}
.esev.sev-high{background:var(--rdd);color:var(--rd)}
.esev.sev-critical{background:rgba(255,59,59,.18);color:#ff3b3b}
.esev.sev-positive{background:var(--gnd);color:var(--gn)}
.edesc{font-size:14px;line-height:1.5;margin-bottom:8px;white-space:pre-wrap;word-break:break-word;color:var(--tx2)}
.emeta{display:flex;flex-wrap:wrap;gap:10px;font-size:12px;color:var(--mt)}
.emeta span{display:flex;align-items:center;gap:3px}
.ebadges{display:flex;gap:5px;margin-top:7px;flex-wrap:wrap}
.badge{font-size:10px;font-weight:600;padding:3px 8px;border-radius:20px;text-transform:uppercase;letter-spacing:.4px}
.badge-ac{background:var(--acd);color:var(--ac)}
.badge-rd{background:var(--rdd);color:var(--rd)}
.badge-gn{background:var(--gnd);color:var(--gn)}

.search-bar{position:relative;margin-bottom:12px}
.search-bar input{width:100%;padding:12px 16px 12px 40px;border-radius:var(--r);border:1px solid var(--bdr);background:var(--s1);color:var(--tx);font-size:15px;outline:none}
.search-bar input:focus{border-color:var(--ac)}
.search-bar .si{position:absolute;left:13px;top:50%;transform:translateY(-50%);color:var(--mt);font-size:16px}
.fbar{display:flex;gap:7px;margin-bottom:14px;overflow-x:auto;padding-bottom:4px;-webkit-overflow-scrolling:touch}
.fbar::-webkit-scrollbar{display:none}
.fchip{flex-shrink:0;padding:7px 13px;border-radius:20px;border:1px solid var(--bdr);background:var(--s1);color:var(--mt);font-size:12px;font-weight:600;cursor:pointer;transition:all .15s;white-space:nowrap}
.fchip.on{border-color:var(--acb);color:var(--ac);background:var(--acd)}
.fchip.fchip-gn.on{border-color:var(--gnb);color:var(--gn);background:var(--gnd)}
.fchip:active{transform:scale(.95)}

.empty{text-align:center;padding:60px 20px;color:var(--mt)}
.empty .ei{font-size:48px;margin-bottom:16px;opacity:.4}
.empty h3{font-size:16px;margin-bottom:8px;color:var(--tx)}
.empty p{font-size:14px;line-height:1.5;max-width:280px;margin:0 auto}

.stats{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px}
.stat{background:var(--s1);border:1px solid var(--bdr);border-radius:var(--r);padding:16px;text-align:center}
.stat .num{font-size:28px;font-weight:700;margin-bottom:4px}
.stat .lbl{font-size:11px;color:var(--mt);text-transform:uppercase;letter-spacing:1px;font-weight:600}
.stor-bar{height:6px;border-radius:3px;background:var(--s3);overflow:hidden;margin-top:8px}
.stor-fill{height:100%;border-radius:3px;background:var(--ac);transition:width .3s}
.xcard{background:var(--s1);border:1px solid var(--bdr);border-radius:var(--r);padding:16px;margin-bottom:10px;cursor:pointer;transition:all .15s;display:flex;align-items:center;gap:14px}
.xcard:active{background:var(--s2);transform:scale(.99)}
.xcard .xi{font-size:28px}
.xcard h3{font-size:15px;font-weight:600;margin-bottom:2px}
.xcard p{font-size:13px;color:var(--mt)}
.disclaimer{margin-top:24px;padding:16px;background:var(--s1);border:1px solid var(--bdr);border-radius:var(--r);font-size:12px;color:var(--mt);line-height:1.6}
.disclaimer strong{color:var(--yw)}

.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:200;display:flex;align-items:flex-end;justify-content:center;opacity:0;pointer-events:none;transition:opacity .2s}
.modal-bg.open{opacity:1;pointer-events:all}
.modal{background:var(--s1);border-radius:20px 20px 0 0;width:100%;max-width:600px;max-height:85vh;overflow-y:auto;padding:20px 20px calc(20px + var(--sab));transform:translateY(100%);transition:transform .3s ease;-webkit-overflow-scrolling:touch}
.modal-bg.open .modal{transform:translateY(0)}
.modal-handle{width:36px;height:4px;background:var(--bdr);border-radius:2px;margin:0 auto 16px}
.modal h2{font-size:18px;margin-bottom:16px;display:flex;align-items:center;gap:8px}
.detail-row{margin-bottom:14px}
.detail-row .dl{font-size:11px;font-weight:700;color:var(--mt);text-transform:uppercase;letter-spacing:.8px;margin-bottom:4px}
.detail-row .dv{font-size:14px;line-height:1.6;white-space:pre-wrap}
.modal-media{display:flex;gap:8px;flex-wrap:wrap;margin-top:4px}
.modal-media .mm{width:72px;height:72px;border-radius:8px;overflow:hidden;background:var(--s3);cursor:pointer;display:flex;align-items:center;justify-content:center}
.modal-media .mm img{width:100%;height:100%;object-fit:cover}
.modal-media .mm video{width:100%;height:100%;object-fit:cover}
.modal-actions{display:flex;gap:8px;margin-top:20px}
.modal-actions .sbtn{margin:0;flex:1}
.dbtn{flex:.6;padding:14px;border-radius:var(--r);border:1px solid var(--rdb);background:var(--rdd);color:var(--rd);font-size:13px;font-weight:600;cursor:pointer}
.dbtn:active{transform:scale(.95)}
.detail-id{font-size:11px;color:var(--mt);font-family:monospace;margin-top:12px;line-height:1.8}

.note{padding:12px 16px;border-radius:var(--r);margin-bottom:14px;font-size:13px;line-height:1.5;display:flex;gap:10px;align-items:flex-start}
.note .ni{font-size:18px;flex-shrink:0}
.note-info{background:var(--acd);border:1px solid var(--acb);color:var(--ac)}
.note-warn{background:var(--ywd);border:1px solid var(--ywb);color:var(--yw)}
.note-gn{background:var(--gnd);border:1px solid var(--gnb);color:var(--gn)}

.toast{position:fixed;bottom:calc(90px + var(--sab));left:50%;transform:translateX(-50%) translateY(20px);background:var(--gn);color:#fff;padding:12px 24px;border-radius:var(--r);font-size:14px;font-weight:600;z-index:300;opacity:0;transition:all .3s;pointer-events:none;white-space:nowrap}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
.toast.warn{background:var(--yw);color:#1a1a1a}

.media-viewer{position:fixed;inset:0;background:rgba(0,0,0,.95);z-index:400;display:flex;align-items:center;justify-content:center;padding:20px;cursor:pointer}
.media-viewer img{max-width:100%;max-height:100%;object-fit:contain;border-radius:8px}

/* Onboarding */
.ob-overlay{position:fixed;inset:0;background:var(--bg);z-index:500;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:calc(40px + var(--sat)) 24px calc(40px + var(--sab))}
.ob-overlay h1{font-size:28px;font-weight:700;margin-bottom:8px;text-align:center}
.ob-overlay .ob-sub{text-align:center;color:var(--mt);font-size:15px;margin-bottom:32px;line-height:1.5}
.ob-section{background:var(--s1);border:1px solid var(--bdr);border-radius:var(--r);padding:20px;margin-bottom:14px}
.ob-section h2{font-size:16px;font-weight:700;margin-bottom:10px;display:flex;align-items:center;gap:8px}
.ob-section p,.ob-section li{font-size:14px;color:var(--tx2);line-height:1.7}
.ob-section ul{margin:8px 0 0 20px}
.ob-section li{margin-bottom:4px}
.ob-section .ob-tip{font-size:12px;color:var(--mt);font-style:italic;margin-top:10px}
.ob-start{width:100%;padding:18px;border-radius:var(--r);border:none;background:var(--ac);color:#fff;font-size:17px;font-weight:700;cursor:pointer;margin-top:20px;letter-spacing:.3px}
.ob-start:active{transform:scale(.98);opacity:.9}

@media(min-width:500px){.cat-grid{grid-template-columns:1fr 1fr 1fr}}
@media(min-width:640px){.content,.tabs{max-width:640px;margin-left:auto;margin-right:auto}.stats{grid-template-columns:repeat(3,1fr)}}
@media(min-width:1024px){.content,.tabs{max-width:720px}}
</style>
</head>
<body>

<div id="app"></div>
<div class="toast" id="toast"></div>

<input type="file" id="photoInput" accept="image/*" capture="environment" style="display:none">
<input type="file" id="videoInput" accept="video/*" capture="environment" style="display:none">
<input type="file" id="audioInput" accept="audio/*" capture="microphone" style="display:none">
<input type="file" id="fileInput" accept="image/*,video/*,audio/*" style="display:none">
<input type="file" id="importInput" accept=".json" style="display:none">

<script>
// CustodyLog v3 ‚Äî Incidents + Positive Moments
const USER_NAME = 'Zev';
const SP = 'cl_zev';

// Incident categories
const CATS = [
  { id:'emotional',    icon:'üî¥', label:'Emotional Outburst',     g:'behavior' },
  { id:'threat',       icon:'‚ö†Ô∏è', label:'Threats / Intimidation', g:'behavior' },
  { id:'exchange',     icon:'üîÑ', label:'Custody Exchange Issue',  g:'custody' },
  { id:'violation',    icon:'‚öñÔ∏è', label:'Court Order Violation',  g:'custody' },
  { id:'communication',icon:'üí¨', label:'Hostile Communication',  g:'comms' },
  { id:'accusation',   icon:'üö®', label:'False Accusation',       g:'comms' },
  { id:'boundary',     icon:'üöß', label:'Boundary Violation',     g:'comms' },
  { id:'alienation',   icon:'üíî', label:'Alienation Behavior',    g:'children' },
  { id:'wellbeing',    icon:'üë∂', label:"Children's Wellbeing",   g:'children' },
  { id:'neglect',      icon:'üè†', label:'Neglect / Safety',       g:'children' },
  { id:'substance',    icon:'üç∑', label:'Substance Abuse',        g:'concern' },
  { id:'financial',    icon:'üí∞', label:'Financial Issue',         g:'concern' },
  { id:'harassment',   icon:'üìµ', label:'Harassment / Stalking',  g:'concern' },
  { id:'witness',      icon:'üëÅÔ∏è', label:'Witness Observation',    g:'docs' },
  { id:'other',        icon:'üìù', label:'Other / General Note',   g:'docs' },
];

const GROUPS = {
  behavior:'üî¥ Behavior & Safety',
  custody:'‚öñÔ∏è Custody & Court',
  comms:'üí¨ Communication',
  children:'üë∂ Children',
  concern:'‚ö†Ô∏è Concerns',
  docs:'üìã Documentation'
};

// Positive moment categories
const PCATS = [
  { id:'quality_time', icon:'üéØ', label:'Quality Time Together',  g:'together' },
  { id:'activity',     icon:'üé®', label:'Fun Activity / Outing',  g:'together' },
  { id:'routine',      icon:'üè°', label:'Daily Care & Routine',   g:'together' },
  { id:'emotional',    icon:'üíõ', label:'Emotional Support',       g:'together' },
  { id:'milestone',    icon:'‚≠ê', label:'Milestone / Achievement', g:'growth' },
  { id:'school',       icon:'üìö', label:'School / Education',      g:'growth' },
  { id:'health',       icon:'ü©∫', label:'Health & Wellness',       g:'growth' },
  { id:'coparenting',  icon:'ü§ù', label:'Co-Parenting Win',        g:'coparent' },
  { id:'communication',icon:'üí¨', label:'Positive Communication',  g:'coparent' },
  { id:'event',        icon:'üéâ', label:'Special Event / Holiday', g:'memorable' },
  { id:'memory',       icon:'üì∏', label:'Happy Memory',            g:'memorable' },
  { id:'other_pos',    icon:'‚ú®', label:'Other Positive Note',     g:'memorable' },
];

const PGROUPS = {
  together:'üë®‚Äçüëß‚Äçüë¶ Time Together',
  growth:'‚≠ê Growth & Development',
  coparent:'ü§ù Co-Parenting',
  memorable:'üéâ Memorable Moments'
};

const SEVS = [
  {id:'low',label:'Low',cls:'s-low'},
  {id:'medium',label:'Medium',cls:'s-medium'},
  {id:'high',label:'High',cls:'s-high'},
  {id:'critical',label:'Critical',cls:'s-critical'},
];

// IndexedDB ‚Äî large storage for entries & drafts (hundreds of MB)
let _db = null;
function idb() {
  if (_db) return Promise.resolve(_db);
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(SP + '_db', 1);
    req.onupgradeneeded = () => req.result.createObjectStore('kv');
    req.onsuccess = () => { _db = req.result; resolve(_db); };
    req.onerror = () => reject(req.error);
  });
}
function idbGet(key) {
  return idb().then(db => new Promise((res, rej) => {
    const r = db.transaction('kv','readonly').objectStore('kv').get(key);
    r.onsuccess = () => res(r.result);
    r.onerror = () => rej(r.error);
  }));
}
function idbSet(key, val) {
  return idb().then(db => new Promise((res, rej) => {
    const r = db.transaction('kv','readwrite').objectStore('kv').put(val, key);
    r.onsuccess = () => res();
    r.onerror = () => rej(r.error);
  }));
}
function idbDel(key) {
  return idb().then(db => new Promise((res, rej) => {
    const r = db.transaction('kv','readwrite').objectStore('kv').delete(key);
    r.onsuccess = () => res();
    r.onerror = () => rej(r.error);
  }));
}
function idbClear() {
  return idb().then(db => new Promise((res, rej) => {
    const r = db.transaction('kv','readwrite').objectStore('kv').clear();
    r.onsuccess = () => res();
    r.onerror = () => rej(r.error);
  }));
}

// Storage ‚Äî localStorage for tiny settings, IndexedDB for data
let _cachedDraft = null;
let _storageQuota = 0;
const LS = {
  save: (e) => { idbSet('entries', e).catch(err => toast('Storage error!', true)); },
  pin: () => localStorage.getItem(SP+'_pin'),
  setPin: (p) => localStorage.setItem(SP+'_pin', p),
  rmPin: () => localStorage.removeItem(SP+'_pin'),
  seen: () => localStorage.getItem(SP+'_seen') === '1',
  setSeen: () => localStorage.setItem(SP+'_seen', '1'),
  onboarded: () => localStorage.getItem(SP+'_onboarded') === '1',
  setOnboarded: () => localStorage.setItem(SP+'_onboarded', '1'),
  saveDraft: (d) => { _cachedDraft = d; idbSet('draft', d).catch(()=>{}); },
  loadDraft: () => _cachedDraft,
  clearDraft: () => { _cachedDraft = null; idbDel('draft').catch(()=>{}); },
  hasDraft: () => { const d = _cachedDraft; return d && (d.cat || d.desc); },
};

// State
let S = {
  screen: 'boot',
  pinDigits: [], pinPhase: 'first', pinFirst: [], pinError: '',
  tab: 'new', page: 'categories',
  entryType: 'incident', // 'incident' or 'positive'
  cat: '', severity: 'medium', desc: '', date: '', time: '',
  location: '', witnesses: '', kidsThere: false, kidsNames: '',
  media: [], editId: null,
  filter: 'all', search: '', logTypeFilter: 'all', // 'all', 'incidents', 'positive'
  viewing: null,
  entries: [],
};

// Draft auto-save
function saveDraft() {
  LS.saveDraft({
    entryType:S.entryType, cat:S.cat, severity:S.severity, desc:S.desc, date:S.date, time:S.time,
    location:S.location, witnesses:S.witnesses, kidsThere:S.kidsThere,
    kidsNames:S.kidsNames, media:S.media
  });
}

function loadDraft() {
  const d = LS.loadDraft();
  if (!d) return;
  S.entryType=d.entryType||'incident'; S.cat=d.cat||''; S.severity=d.severity||'medium'; S.desc=d.desc||'';
  S.date=d.date||''; S.time=d.time||''; S.location=d.location||'';
  S.witnesses=d.witnesses||''; S.kidsThere=d.kidsThere||false;
  S.kidsNames=d.kidsNames||''; S.media=d.media||[];
  if (S.cat) S.page = 'form';
}

// Storage usage ‚Äî calculated from in-memory data
function storageUsed() {
  try { return JSON.stringify(S.entries).length * 2; } catch { return 0; }
}
function fmtBytes(b){if(b<1024)return b+' B';if(b<1048576)return(b/1024).toFixed(1)+' KB';return(b/1048576).toFixed(1)+' MB';}

// Helpers to determine entry type
function isPositive(entry) { return entry.type === 'positive'; }
function entryTypeLabel(entry) { return isPositive(entry) ? 'Positive' : (entry.severity || 'medium'); }

// Init ‚Äî async to load from IndexedDB
async function boot() {
  // Load entries from IndexedDB
  try {
    let entries = await idbGet('entries');
    // Migrate from localStorage if IndexedDB is empty
    if (!entries) {
      const old = localStorage.getItem(SP+'_entries');
      if (old) {
        try { entries = JSON.parse(old); await idbSet('entries', entries); localStorage.removeItem(SP+'_entries'); } catch {}
      }
    }
    S.entries = entries || [];
  } catch { S.entries = []; }

  // Load draft from IndexedDB
  try {
    let draft = await idbGet('draft');
    if (!draft) {
      const oldDraft = localStorage.getItem(SP+'_draft');
      if (oldDraft) {
        try { draft = JSON.parse(oldDraft); await idbSet('draft', draft); localStorage.removeItem(SP+'_draft'); } catch {}
      }
    }
    _cachedDraft = draft || null;
  } catch { _cachedDraft = null; }

  // Get storage quota estimate
  try {
    if (navigator.storage && navigator.storage.estimate) {
      const est = await navigator.storage.estimate();
      _storageQuota = est.quota || 0;
    }
  } catch {}

  const pin = LS.pin();
  if (pin) S.screen = 'pin_enter';
  else if (!LS.seen()) S.screen = 'pin_create';
  else if (!LS.onboarded()) S.screen = 'onboarding';
  else S.screen = 'app';
  loadDraft();
  render();
}

// Render
function render() {
  const app = document.getElementById('app');
  if (S.screen === 'pin_create') { app.innerHTML = pinCreateHTML(); return; }
  if (S.screen === 'pin_enter')  { app.innerHTML = pinEnterHTML();  return; }
  if (S.screen === 'onboarding') { app.innerHTML = onboardingHTML(); return; }
  app.innerHTML = appHTML();
}

// Onboarding
function onboardingHTML() {
  return `<div class="ob-overlay fadeIn">
    <div style="max-width:520px;margin:0 auto">
      <div style="font-size:56px;text-align:center;margin-bottom:12px">üõ°Ô∏è</div>
      <h1>Welcome to CustodyLog</h1>
      <p class="ob-sub">Your private, secure documentation tool for custody matters.</p>

      <div class="ob-section">
        <h2>üìã What This App Does</h2>
        <p>CustodyLog helps you maintain a detailed, timestamped record of <strong>both incidents and positive interactions</strong> related to your custody situation. All data is stored privately on your device ‚Äî nothing is ever sent to any server.</p>
      </div>

      <div class="ob-section">
        <h2>üî¥ Logging Incidents</h2>
        <p>Document concerning behavior, court order violations, communication issues, and other incidents as they happen.</p>
        <ul>
          <li><strong>Be factual and specific</strong> ‚Äî describe what you saw, heard, or received</li>
          <li><strong>Avoid opinions</strong> ‚Äî let the facts speak for themselves</li>
          <li><strong>Attach evidence</strong> ‚Äî photos, screenshots, or recordings</li>
          <li><strong>Note witnesses</strong> and whether children were present</li>
          <li><strong>Rate severity</strong> so your attorney can prioritize</li>
        </ul>
      </div>

      <div class="ob-section">
        <h2>üíö Logging Positive Moments</h2>
        <p>Record quality time, milestones, and positive co-parenting interactions. This is just as important as logging incidents.</p>
        <ul>
          <li>Shows a <strong>pattern of active, engaged parenting</strong></li>
          <li>Documents healthy routines and stability</li>
          <li>Records successful co-parenting communication</li>
          <li>Positive entries appear <strong>first in attorney reports</strong></li>
        </ul>
      </div>

      <div class="ob-section">
        <h2>üìÖ Backdating Entries</h2>
        <p>You can change the date and time on any entry to log something that happened in the past. The app automatically records <strong>when the entry was actually created</strong> for credibility ‚Äî both dates appear in reports.</p>
      </div>

      <div class="ob-section">
        <h2>üîí Privacy & Backups</h2>
        <ul>
          <li>All data stays on <strong>your device</strong> ‚Äî no cloud, no servers</li>
          <li>Set a PIN to protect your entries from prying eyes</li>
          <li><strong>Export backups regularly</strong> ‚Äî clearing your browser data will delete everything</li>
          <li>Generate attorney-ready PDF reports anytime</li>
        </ul>
        <p class="ob-tip">This is not legal advice. Always consult with your attorney about your specific situation.</p>
      </div>

      <button class="ob-start" onclick="finishOnboarding()">Get Started</button>
    </div>
  </div>`;
}

function finishOnboarding() { LS.setOnboarded(); S.screen = 'app'; render(); }
function showOnboarding() { S.screen = 'onboarding'; render(); }

// PIN
function pinCreateHTML() {
  const title = S.pinPhase === 'first' ? 'Create a PIN' : 'Confirm Your PIN';
  const sub = S.pinPhase === 'first' ? 'Choose a 4-digit PIN to protect your entries.' : 'Enter your PIN again to confirm.';
  return `<div class="pin-wrap fadeIn">
    <div class="pin-logo">üõ°Ô∏è</div>
    <h1>${title}</h1>
    <p class="sub">${sub}</p>
    ${pinDotsHTML()}
    ${pinPadHTML()}
    <div class="pin-msg">${S.pinError}</div>
    <button class="pin-skip" onclick="skipPin()">Skip ‚Äî I'll set one later</button>
  </div>`;
}

function pinEnterHTML() {
  return `<div class="pin-wrap fadeIn">
    <div class="pin-logo">üîí</div>
    <h1>${USER_NAME}'s CustodyLog</h1>
    <p class="sub">Enter your PIN to unlock</p>
    ${pinDotsHTML()}
    ${pinPadHTML()}
    <div class="pin-msg">${S.pinError}</div>
    <button class="pin-skip" onclick="resetAll()">Forgot PIN? Reset app</button>
  </div>`;
}

function pinDotsHTML() {
  let h = '<div class="pin-dots">';
  for (let i = 0; i < 4; i++) {
    const filled = i < S.pinDigits.length;
    const err = S.pinError ? ' error' : '';
    h += `<div class="pin-dot${filled ? ' filled' : ''}${err}"></div>`;
  }
  return h + '</div>';
}

function pinPadHTML() {
  const keys = [1,2,3,4,5,6,7,8,9,'','0','‚å´'];
  let h = '<div class="pin-pad">';
  keys.forEach(k => {
    if (k === '') h += '<div class="pin-key empty"></div>';
    else if (k === '‚å´') h += `<div class="pin-key fn" onclick="pinBack()">‚å´</div>`;
    else h += `<div class="pin-key" onclick="pinTap(${k})">${k}</div>`;
  });
  return h + '</div>';
}

function pinTap(n) {
  if (S.pinDigits.length >= 4) return;
  S.pinError = '';
  S.pinDigits.push(n);
  render();
  if (S.pinDigits.length === 4) {
    setTimeout(() => {
      if (S.screen === 'pin_create') handlePinCreate();
      else handlePinEnter();
    }, 200);
  }
}

function pinBack() { S.pinDigits.pop(); S.pinError = ''; render(); }

function handlePinCreate() {
  const code = S.pinDigits.join('');
  if (S.pinPhase === 'first') {
    S.pinFirst = [...S.pinDigits]; S.pinDigits = []; S.pinPhase = 'confirm'; render();
  } else {
    if (code === S.pinFirst.join('')) {
      LS.setPin(code); LS.setSeen(); S.pinDigits = [];
      if (!LS.onboarded()) { S.screen = 'onboarding'; }
      else { S.screen = 'app'; toast('üîí PIN set successfully'); }
      render();
    } else {
      S.pinError = 'PINs don\'t match. Try again.';
      S.pinDigits = []; S.pinPhase = 'first'; S.pinFirst = []; render();
    }
  }
}

function handlePinEnter() {
  const code = S.pinDigits.join('');
  if (code === LS.pin()) {
    S.pinDigits = []; S.screen = 'app'; render();
  } else {
    S.pinError = 'Wrong PIN. Try again.'; S.pinDigits = []; render();
    const dots = document.querySelector('.pin-dots');
    if (dots) dots.classList.add('shake');
  }
}

function skipPin() {
  LS.setSeen();
  if (!LS.onboarded()) { S.screen = 'onboarding'; }
  else { S.screen = 'app'; }
  render();
}

function resetAll() {
  if (!confirm('This will delete ALL data and reset the app. Are you sure?')) return;
  const keys=[];
  for(let i=0;i<localStorage.length;i++){const k=localStorage.key(i);if(k&&k.startsWith(SP))keys.push(k);}
  keys.forEach(k=>localStorage.removeItem(k));
  idbClear().catch(()=>{});
  S.entries = []; _cachedDraft = null; S.pinDigits = []; S.screen = 'pin_create'; S.pinPhase = 'first';
  toast('App reset'); render();
}

// APP
function appHTML() {
  return `${headerHTML()}${tabsHTML()}
    <div class="content">
      ${S.tab === 'new' ? (S.page === 'categories' ? categoriesHTML() : formHTML()) : ''}
      ${S.tab === 'log' ? logHTML() : ''}
      ${S.tab === 'export' ? exportTabHTML() : ''}
    </div>${S.viewing ? modalHTML() : ''}`;
}

function headerHTML() {
  return `<div class="header">
    <h1><span>üõ°Ô∏è</span> ${USER_NAME}'s CustodyLog</h1>
    <div class="hdr-btns">
      <button class="ibtn" onclick="showOnboarding()" title="Help">?</button>
      <button class="ibtn" onclick="lockApp()" title="Lock">üîí</button>
    </div>
  </div>`;
}

function tabsHTML() {
  const draft = LS.hasDraft() && !S.editId;
  const tt = [
    {id:'new', label: S.page==='form' ? '‚Üê Back' : (draft ? '+ New üìù' : '+ New Entry')},
    {id:'log', label:`Log (${S.entries.length})`},
    {id:'export', label:'Export'},
  ];
  return `<div class="tabs">
    ${tt.map(t => `<button class="tab ${S.tab===t.id?'on':''}" onclick="setTab('${t.id}')">${t.label}</button>`).join('')}
  </div>`;
}

function setTab(t) {
  if (t === 'new' && S.tab === 'new' && S.page === 'form') { S.page = 'categories'; render(); return; }
  S.tab = t;
  if (t === 'new') S.page = S.cat ? 'form' : 'categories';
  render();
}

// Categories ‚Äî with type switcher
function categoriesHTML() {
  let h = '';
  if (!LS.pin()) {
    h += `<div class="note note-info"><span class="ni">üîí</span><span>Your data is stored only on this device. Tap the lock icon to set a PIN.</span></div>`;
  }

  // Type switcher
  h += `<div class="type-switch">
    <button class="type-btn t-incident ${S.entryType==='incident'?'on':''}" onclick="S.entryType='incident';render();">
      <span class="ti">üìã</span>Log Incident
    </button>
    <button class="type-btn t-positive ${S.entryType==='positive'?'on':''}" onclick="S.entryType='positive';render();">
      <span class="ti">üíö</span>Log Positive Moment
    </button>
  </div>`;

  if (S.entryType === 'incident') {
    const groups = {};
    CATS.forEach(c => { if (!groups[c.g]) groups[c.g] = []; groups[c.g].push(c); });
    for (const [g, cats] of Object.entries(groups)) {
      h += `<div class="grp-label">${GROUPS[g]}</div><div class="cat-grid">`;
      cats.forEach(c => {
        h += `<button class="cat-btn" onclick="pickCat('${c.id}','incident')"><span class="ci">${c.icon}</span>${c.label}</button>`;
      });
      h += '</div>';
    }
  } else {
    const groups = {};
    PCATS.forEach(c => { if (!groups[c.g]) groups[c.g] = []; groups[c.g].push(c); });
    for (const [g, cats] of Object.entries(groups)) {
      h += `<div class="grp-label">${PGROUPS[g]}</div><div class="cat-grid">`;
      cats.forEach(c => {
        h += `<button class="cat-btn" onclick="pickCat('${c.id}','positive')" style="border-color:rgba(81,207,150,.2)"><span class="ci">${c.icon}</span>${c.label}</button>`;
      });
      h += '</div>';
    }
  }
  return h;
}

function pickCat(id, type) {
  S.cat = id; S.entryType = type; S.page = 'form';
  const n = nowDT();
  if (!S.editId) { S.date = n.date; S.time = n.time; }
  saveDraft(); render(); window.scrollTo(0, 0);
}

// Find category in either list
function findCat(id, type) {
  if (type === 'positive') return PCATS.find(c => c.id === id);
  return CATS.find(c => c.id === id);
}

function catLabel(id, type) {
  const c = findCat(id, type);
  return c ? c.label : id;
}

// Form ‚Äî adapts for incident vs positive
function formHTML() {
  const isPos = S.entryType === 'positive';
  const cat = findCat(S.cat, S.entryType);
  const descPlaceholder = isPos
    ? 'Describe what happened. What did you do together? How did the kids react? Include details that paint a picture.'
    : 'Describe exactly what was said or done. Stick to what you saw, heard, or received. Avoid opinions \u2014 let the facts speak.';
  const descLabel = isPos ? 'What happened? (Be descriptive)' : 'What happened? (Be factual & specific)';

  return `<div class="form-page slideRight">
    <div class="back-bar" onclick="S.page='categories';render();">
      <span class="arrow">‚Üê</span>
      <span class="cat-tag">${cat ? cat.icon : ''} ${cat ? cat.label : ''}</span>
      ${isPos ? '<span class="esev sev-positive" style="margin-left:8px">Positive</span>' : ''}
    </div>
    ${S.editId ? `<div class="note note-warn"><span class="ni">‚úèÔ∏è</span><span>Editing existing entry</span></div>` : ''}
    ${!isPos ? `<div class="fgroup">
      <label class="flabel">Severity</label>
      <div class="sev-row">
        ${SEVS.map(s => `<button class="sev-btn ${S.severity===s.id?s.cls:''}" onclick="S.severity='${s.id}';saveDraft();render();">${s.label}</button>`).join('')}
      </div>
    </div>` : ''}
    <div class="fgroup">
      <label class="flabel">When did this ${isPos ? 'happen' : 'occur'}?</label>
      <div class="row">
        <input type="date" class="finput" value="${S.date}" onchange="S.date=this.value;saveDraft()">
        <input type="time" class="finput" value="${S.time}" onchange="S.time=this.value;saveDraft()">
      </div>
    </div>
    <div class="fgroup">
      <label class="flabel">${descLabel}</label>
      <textarea class="ftextarea" placeholder="${descPlaceholder}"
        oninput="S.desc=this.value;saveDraft()">${S.desc}</textarea>
    </div>
    <div class="fgroup">
      <label class="flabel">Location (optional)</label>
      <input type="text" class="finput" placeholder="${isPos ? 'Where were you?' : 'Where did this happen?'}" value="${esc(S.location)}" oninput="S.location=this.value;saveDraft()">
    </div>
    ${!isPos ? `<div class="fgroup">
      <label class="flabel">Witnesses (optional)</label>
      <input type="text" class="finput" placeholder="Names of anyone who saw or heard" value="${esc(S.witnesses)}" oninput="S.witnesses=this.value;saveDraft()">
    </div>` : ''}
    <div class="chk-row" onclick="S.kidsThere=!S.kidsThere;saveDraft();render();">
      <input type="checkbox" ${S.kidsThere?'checked':''} tabindex="-1">
      <label>${isPos ? 'Children were with me' : 'Children were present / involved'}</label>
    </div>
    ${S.kidsThere ? `<div class="fgroup" style="margin-top:0">
      <input type="text" class="finput" placeholder="Which children? (names/ages)" value="${esc(S.kidsNames)}" oninput="S.kidsNames=this.value;saveDraft()">
    </div>` : ''}
    <div class="media-section">
      <label class="flabel">${isPos ? 'Photos & Memories (optional)' : 'Attachments (optional)'}</label>
      <div class="media-btns">
        <button class="media-btn" onclick="addMedia('photo')"><span class="mi">üì∑</span> Photo</button>
        <button class="media-btn" onclick="addMedia('video')"><span class="mi">üé•</span> Video</button>
        ${!isPos ? `<button class="media-btn" onclick="addMedia('audio')"><span class="mi">üéôÔ∏è</span> Audio</button>` : ''}
        <button class="media-btn" onclick="addMedia('file')"><span class="mi">üìé</span> File</button>
      </div>
      ${S.media.length ? `<div class="media-list">
        ${S.media.map((m, i) => `<div class="media-item slideUp">
          <div class="mthumb">${mediaThumbnail(m)}</div>
          <div class="minfo">
            <div class="mname">${esc(m.name)}</div>
            <div class="msize">${fmtSize(m.size)}</div>
          </div>
          <button class="mrem" onclick="removeMedia(${i})">√ó</button>
        </div>`).join('')}
      </div>` : ''}
    </div>
    <button class="pbtn${isPos?' pbtn-gn':''}" onclick="saveEntry()" ${!S.desc.trim()?'disabled':''}>${S.editId ? 'üíæ Update Entry' : (isPos ? 'üíö Save Positive Moment' : 'üíæ Save Entry')}</button>
    ${S.editId ? `<button class="sbtn" onclick="cancelEdit()">Cancel</button>` : ''}
    ${!S.editId && (S.desc || S.media.length) ? `<button class="sbtn" style="color:var(--rd);border-color:var(--rdb)" onclick="clearForm()">Clear Form</button>` : ''}
  </div>`;
}

// Media
function compressImage(file, maxDim, quality) {
  return new Promise((resolve, reject) => {
    const url = URL.createObjectURL(file);
    const img = new Image();
    img.onload = () => {
      URL.revokeObjectURL(url);
      let w = img.width, h = img.height;
      if (w > maxDim || h > maxDim) {
        if (w > h) { h = Math.round(h * maxDim / w); w = maxDim; }
        else { w = Math.round(w * maxDim / h); h = maxDim; }
      }
      const c = document.createElement('canvas');
      c.width = w; c.height = h;
      c.getContext('2d').drawImage(img, 0, 0, w, h);
      const dataUrl = c.toDataURL('image/jpeg', quality);
      resolve(dataUrl);
    };
    img.onerror = () => { URL.revokeObjectURL(url); reject(new Error('Image load failed')); };
    img.src = url;
  });
}

function addMedia(type) {
  const inputMap = { photo:'photoInput', video:'videoInput', audio:'audioInput', file:'fileInput' };
  const el = document.getElementById(inputMap[type]);
  el.value = '';
  el.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    if (file.size > 10 * 1024 * 1024) { toast('File too large (10MB max).', true); return; }
    if (type === 'photo' && file.type.startsWith('image/')) {
      try {
        toast('Compressing photo...');
        const dataUrl = await compressImage(file, 1200, 0.7);
        const size = Math.round(dataUrl.length * 0.75);
        S.media.push({ name: file.name, type: 'image/jpeg', size, data: dataUrl });
        saveDraft(); render(); toast('Photo attached (' + fmtBytes(size) + ')');
      } catch { toast('Could not process image', true); }
    } else {
      const reader = new FileReader();
      reader.onload = (ev) => {
        S.media.push({ name: file.name, type: file.type, size: file.size, data: ev.target.result });
        saveDraft(); render(); toast('File attached');
      };
      reader.readAsDataURL(file);
    }
  };
  el.click();
}

function removeMedia(i) { S.media.splice(i, 1); saveDraft(); render(); }

function mediaThumbnail(m) {
  if (m.type.startsWith('image/')) return `<img src="${m.data}" alt="">`;
  if (m.type.startsWith('video/')) return 'üé•';
  if (m.type.startsWith('audio/')) return 'üéôÔ∏è';
  return 'üìé';
}

function fmtSize(b) {
  if (b < 1024) return b + ' B';
  if (b < 1048576) return (b/1024).toFixed(1) + ' KB';
  return (b/1048576).toFixed(1) + ' MB';
}

function openMedia(entryId, mediaIdx) {
  const entry = S.entries.find(e => e.id === entryId) || S.viewing;
  if (!entry || !entry.media || !entry.media[mediaIdx]) return;
  const m = entry.media[mediaIdx];
  if (!m.type.startsWith('image/')) return;
  const overlay = document.createElement('div');
  overlay.className = 'media-viewer';
  overlay.onclick = () => overlay.remove();
  const img = document.createElement('img');
  img.src = m.data; img.alt = 'Photo';
  overlay.appendChild(img);
  document.body.appendChild(overlay);
}

// Save
function saveEntry() {
  if (!S.desc.trim() || !S.cat) return;
  const isEdit = !!S.editId;
  const isPos = S.entryType === 'positive';
  const n = nowDT();
  const entry = {
    id: S.editId || genId(),
    type: isPos ? 'positive' : 'incident',
    category: S.cat, severity: isPos ? 'positive' : S.severity,
    description: S.desc.trim(),
    date: S.date || n.date, time: S.time || n.time,
    location: S.location.trim(), witnesses: isPos ? '' : S.witnesses.trim(),
    kidsThere: S.kidsThere, kidsNames: S.kidsNames.trim(),
    media: S.media.map(m => ({name:m.name, type:m.type, size:m.size, data:m.data})),
    createdAt: isEdit ? (S.entries.find(e=>e.id===S.editId)||{}).createdAt || new Date().toISOString() : new Date().toISOString(),
    updatedAt: new Date().toISOString(),
  };

  if (isEdit) {
    const idx = S.entries.findIndex(e => e.id === S.editId);
    if (idx >= 0) S.entries[idx] = entry;
  } else {
    S.entries.push(entry);
  }

  LS.save(S.entries);
  LS.clearDraft();
  toast(isEdit ? 'Entry updated' : (isPos ? 'üíö Positive moment saved' : 'Entry saved'));
  resetForm();
  S.tab = 'log'; S.page = 'categories';
  render();
}

function resetForm() {
  S.cat=''; S.severity='medium'; S.desc=''; S.date=''; S.time='';
  S.location=''; S.witnesses=''; S.kidsThere=false; S.kidsNames='';
  S.media=[]; S.editId=null; S.entryType='incident';
}

function clearForm() {
  if (!confirm('Clear this form?')) return;
  LS.clearDraft(); resetForm(); S.page='categories'; render();
}

function cancelEdit() { LS.clearDraft(); resetForm(); S.page='categories'; render(); }

// Log
function logHTML() {
  let list = [...S.entries].sort((a,b) => new Date(b.date+'T'+b.time) - new Date(a.date+'T'+a.time));

  // Type filter
  if (S.logTypeFilter === 'incidents') list = list.filter(e => !isPositive(e));
  if (S.logTypeFilter === 'positive') list = list.filter(e => isPositive(e));

  if (S.search) {
    const q = S.search.toLowerCase();
    list = list.filter(e => e.description.toLowerCase().includes(q) || (e.witnesses||'').toLowerCase().includes(q) || (e.location||'').toLowerCase().includes(q) || catLabel(e.category, e.type).toLowerCase().includes(q));
  }
  if (S.filter !== 'all') list = list.filter(e => e.category === S.filter);

  const totalIncidents = S.entries.filter(e => !isPositive(e)).length;
  const totalPositive = S.entries.filter(e => isPositive(e)).length;
  const usedCats = [...new Set(list.map(e => e.category))];

  return `
    <div class="search-bar"><span class="si">üîç</span>
      <input type="text" placeholder="Search entries..." value="${esc(S.search)}" oninput="S.search=this.value;render();">
    </div>
    <div class="fbar">
      <button class="fchip ${S.logTypeFilter==='all'?'on':''}" onclick="S.logTypeFilter='all';S.filter='all';render();">All (${S.entries.length})</button>
      <button class="fchip ${S.logTypeFilter==='incidents'?'on':''}" onclick="S.logTypeFilter='incidents';S.filter='all';render();">üìã Incidents (${totalIncidents})</button>
      <button class="fchip fchip-gn ${S.logTypeFilter==='positive'?'on':''}" onclick="S.logTypeFilter='positive';S.filter='all';render();">üíö Positive (${totalPositive})</button>
    </div>
    ${usedCats.length > 1 ? `<div class="fbar">
      <button class="fchip ${S.filter==='all'?'on':''}" onclick="S.filter='all';render();">All</button>
      ${usedCats.map(cid => {
        const e0 = list.find(e=>e.category===cid);
        const c = findCat(cid, e0 ? e0.type : 'incident');
        const cnt = list.filter(e=>e.category===cid).length;
        return `<button class="fchip ${S.filter===cid?'on':''}" onclick="S.filter='${cid}';render();">${c?c.icon:''} ${c?c.label:cid} (${cnt})</button>`;
      }).join('')}
    </div>` : ''}
    ${list.length === 0 ? `<div class="empty"><div class="ei">${S.logTypeFilter==='positive'?'üíö':'üìã'}</div>
      <h3>${S.entries.length===0?'No entries yet':'No matching entries'}</h3>
      <p>${S.entries.length===0?'Tap "+ New Entry" to log your first entry':'Try adjusting your search or filter'}</p></div>`
    : list.map(e => entryCardHTML(e)).join('')}`;
}

function entryCardHTML(e) {
  const pos = isPositive(e);
  const c = findCat(e.category, e.type);
  const hasMed = e.media && e.media.length > 0;
  const sevColor = pos ? 'var(--gn)' : (e.severity==='critical'||e.severity==='high'?'var(--rd)':e.severity==='medium'?'var(--yw)':'var(--gn)');
  return `<div class="ecard${pos?' ecard-pos':''}" onclick="viewEntry('${e.id}')">
    <div class="ehead">
      <div class="ecat" style="color:${sevColor}">${c?c.icon:'üìù'} ${c?c.label:e.category}</div>
      <span class="esev sev-${pos?'positive':e.severity}">${pos?'Positive':e.severity}</span>
    </div>
    <div class="edesc">${esc(truncate(e.description, 150))}</div>
    <div class="emeta">
      <span>üìÖ ${fmtDate(e.date)}</span>
      <span>üïê ${fmtTime(e.time)}</span>
      ${e.location?`<span>üìç ${esc(truncate(e.location,25))}</span>`:''}
    </div>
    ${(e.kidsThere || e.witnesses || hasMed) ? `<div class="ebadges">
      ${e.kidsThere?`<span class="badge ${pos?'badge-gn':'badge-rd'}">${pos?'Kids With Me':'Children Present'}</span>`:''}
      ${e.witnesses?`<span class="badge badge-ac">Witnessed</span>`:''}
      ${hasMed?`<span class="badge badge-gn">${e.media.length} File${e.media.length>1?'s':''}</span>`:''}
    </div>` : ''}
  </div>`;
}

function viewEntry(id) { S.viewing = S.entries.find(e=>e.id===id)||null; render(); }

function modalHTML() {
  const e = S.viewing;
  if (!e) return '';
  const pos = isPositive(e);
  const c = findCat(e.category, e.type);
  const hasMed = e.media && e.media.length > 0;
  const createdDate = new Date(e.createdAt).toLocaleString();
  const eventDate = fmtDate(e.date) + ' at ' + fmtTime(e.time);
  const datesMatch = e.createdAt && e.date === e.createdAt.slice(0,10);

  return `<div class="modal-bg open" onclick="closeModal(event)"><div class="modal">
    <div class="modal-handle"></div>
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h2>${c?c.icon:''} ${c?c.label:e.category}</h2>
      <span class="esev sev-${pos?'positive':e.severity}">${pos?'Positive':e.severity}</span>
    </div>
    <div class="detail-row"><div class="dl">${pos?'When':'Date & Time'}</div><div class="dv">${eventDate}</div></div>
    ${e.location?`<div class="detail-row"><div class="dl">Location</div><div class="dv">${esc(e.location)}</div></div>`:''}
    <div class="detail-row"><div class="dl">Description</div><div class="dv">${esc(e.description)}</div></div>
    ${e.witnesses && !pos?`<div class="detail-row"><div class="dl">Witnesses</div><div class="dv">${esc(e.witnesses)}</div></div>`:''}
    ${e.kidsThere?`<div class="detail-row"><div class="dl">${pos?'Children With Me':'Children Present'}</div><div class="dv">Yes${e.kidsNames?' ‚Äî '+esc(e.kidsNames):''}</div></div>`:''}
    ${hasMed ? `<div class="detail-row"><div class="dl">${pos?'Photos':'Attachments'} (${e.media.length})</div>
      <div class="modal-media">${e.media.map((m,i) => {
        if (m.type.startsWith('image/')) return `<div class="mm" onclick="event.stopPropagation();openMedia('${e.id}',${i})"><img src="${m.data}"></div>`;
        if (m.type.startsWith('video/')) return `<div class="mm"><video src="${m.data}" controls style="width:100%;height:100%;object-fit:cover"></video></div>`;
        if (m.type.startsWith('audio/')) return `<div class="mm" style="width:140px"><audio src="${m.data}" controls style="width:100%"></audio></div>`;
        return `<div class="mm">üìé</div>`;
      }).join('')}</div></div>` : ''}
    <div class="detail-id">
      ID: ${e.id}<br>
      Logged: ${createdDate}${!datesMatch ? ' (backdated entry)' : ''}${e.updatedAt && e.updatedAt !== e.createdAt ? '<br>Last edited: '+new Date(e.updatedAt).toLocaleString() : ''}
    </div>
    <div class="modal-actions">
      <button class="sbtn" onclick="editEntry('${e.id}')">‚úèÔ∏è Edit</button>
      <button class="dbtn" onclick="deleteEntry('${e.id}')">üóëÔ∏è Delete</button>
    </div>
  </div></div>`;
}

function closeModal(ev) { if (ev.target.classList.contains('modal-bg')) { S.viewing = null; render(); } }

function editEntry(id) {
  const e = S.entries.find(x=>x.id===id);
  if (!e) return;
  S.editId=e.id; S.entryType=e.type||'incident'; S.cat=e.category; S.severity=e.severity||'medium';
  S.desc=e.description; S.date=e.date; S.time=e.time;
  S.location=e.location||''; S.witnesses=e.witnesses||'';
  S.kidsThere=e.kidsThere||false; S.kidsNames=e.kidsNames||'';
  S.media=(e.media||[]).map(m=>({...m}));
  S.viewing=null; S.tab='new'; S.page='form';
  render(); toast('Editing entry');
}

function deleteEntry(id) {
  if (!confirm('Delete this entry permanently?')) return;
  S.entries=S.entries.filter(e=>e.id!==id);
  LS.save(S.entries); S.viewing=null; toast('Entry deleted'); render();
}

function lockApp() {
  if (LS.pin()) { S.screen='pin_enter'; S.pinDigits=[]; S.pinError=''; render(); }
  else { S.screen='pin_create'; S.pinDigits=[]; S.pinPhase='first'; S.pinError=''; render(); }
}

// Export
function exportTabHTML() {
  const totalI = S.entries.filter(e=>!isPositive(e)).length;
  const totalP = S.entries.filter(e=>isPositive(e)).length;
  const sc = {critical:0,high:0,medium:0,low:0};
  S.entries.filter(e=>!isPositive(e)).forEach(e => sc[e.severity]++);
  const used = storageUsed();
  const quota = _storageQuota || 500*1024*1024;
  const pct = Math.min(100, Math.round(used/quota*100));
  const quotaLabel = _storageQuota ? fmtBytes(_storageQuota) : 'large';
  return `
    <div class="stats">
      <div class="stat"><div class="num">${S.entries.length}</div><div class="lbl">Total</div></div>
      <div class="stat"><div class="num" style="color:var(--gn)">${totalP}</div><div class="lbl">Positive</div></div>
      <div class="stat"><div class="num" style="color:var(--rd)">${sc.critical+sc.high}</div><div class="lbl">High+Critical</div></div>
      <div class="stat"><div class="num">${totalI}</div><div class="lbl">Incidents</div></div>
      <div class="stat"><div class="num">${S.entries.reduce((n,e)=>(e.media?e.media.length:0)+n,0)}</div><div class="lbl">Attachments</div></div>
      <div class="stat">
        <div class="num" style="font-size:18px">${fmtBytes(used)}</div>
        <div class="lbl">used</div>
        <div class="stor-bar"><div class="stor-fill" style="width:${pct}%"></div></div>
        <div class="lbl" style="margin-top:2px;font-size:10px">${quotaLabel} available</div>
      </div>
    </div>
    <div class="grp-label">üì§ Export Options</div>
    <div class="xcard" onclick="exportReport()"><div class="xi">üìÑ</div><div><h3>Attorney-Ready Report</h3><p>Positive moments + incidents ‚Äî print or save as PDF</p></div></div>
    <div class="xcard" onclick="exportMediaZip()"><div class="xi">üì¶</div><div><h3>Media Bundle (ZIP)</h3><p>All photos, videos & files ‚Äî cross-referenced to report by Entry ID</p></div></div>
    <div class="xcard" onclick="exportCSV()"><div class="xi">üìä</div><div><h3>Spreadsheet (CSV)</h3><p>For Excel or Google Sheets</p></div></div>
    <div class="xcard" onclick="exportJSON()"><div class="xi">üíæ</div><div><h3>Full Backup (JSON)</h3><p>Complete data backup with attachments</p></div></div>
    <div class="xcard" onclick="importJSON()"><div class="xi">üì•</div><div><h3>Restore from Backup</h3><p>Import a previous backup file</p></div></div>
    <div class="disclaimer"><strong>‚ö†Ô∏è Important:</strong> Data is stored locally on your device only. No data is sent to any server. <strong>Always export backups regularly.</strong> Clearing browser data will delete all entries. This app is not legal advice ‚Äî consult your attorney.</div>`;
}

function exportReport() {
  if (!S.entries.length) { toast('No entries'); return; }
  const positives = [...S.entries].filter(e=>isPositive(e)).sort((a,b)=>new Date(a.date+'T'+a.time)-new Date(b.date+'T'+b.time));
  const incidents = [...S.entries].filter(e=>!isPositive(e)).sort((a,b)=>new Date(a.date+'T'+a.time)-new Date(b.date+'T'+b.time));
  const now = new Date().toLocaleString();
  let h = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Custody Documentation ‚Äî ${USER_NAME} ‚Äî ${now}</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@400;600;700&display=swap');
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Source Sans 3',Arial,sans-serif;max-width:800px;margin:0 auto;padding:40px 30px;color:#1a1a1a;font-size:14px;line-height:1.6}
@media print{body{padding:20px;font-size:12px}.no-print{display:none}.entry{break-inside:avoid}}
h1{font-size:22px;margin-bottom:4px}
.sub{color:#666;font-size:13px;margin-bottom:20px}
.conf{background:#fff3cd;border:1px solid #ffc107;padding:10px 14px;border-radius:6px;margin-bottom:20px;font-size:12px;font-weight:600;color:#856404}
.summary{background:#f8f9fa;border:1px solid #dee2e6;border-radius:6px;padding:16px;margin-bottom:20px}
.summary h2{font-size:14px;margin-bottom:10px;text-transform:uppercase;letter-spacing:1px;color:#495057}
.sg{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
.si{text-align:center}.si .n{font-size:24px;font-weight:700}.si .l{font-size:11px;color:#666;text-transform:uppercase}
.section-header{font-size:20px;margin:30px 0 16px;padding-bottom:8px;border-bottom:3px solid}
.section-header.sh-pos{border-color:#28a745;color:#28a745}
.section-header.sh-inc{border-color:#dc3545;color:#dc3545}
.monthh{font-size:16px;margin:24px 0 12px;padding-bottom:6px;border-bottom:2px solid #dee2e6}
.entry{border:1px solid #dee2e6;border-radius:6px;padding:16px;margin-bottom:12px}
.entry.entry-pos{border-left:4px solid #28a745}
.eh{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:6px}
.ec{font-weight:700;font-size:13px;text-transform:uppercase;letter-spacing:.5px}
.es{font-size:11px;font-weight:700;padding:2px 8px;border-radius:12px;text-transform:uppercase}
.s-critical{background:#f8d7da;color:#842029}.s-high{background:#ffe5d0;color:#984c0c}
.s-medium{background:#fff3cd;color:#664d03}.s-low{background:#d1e7dd;color:#0f5132}
.s-positive{background:#d1e7dd;color:#0f5132}
.ed{font-size:13px;color:#495057;margin-bottom:6px}
.edesc{font-size:14px;line-height:1.7;margin-bottom:8px;white-space:pre-wrap}
.edet{font-size:12px;color:#666}.edet span{margin-right:14px}
.cf{color:#dc3545;font-weight:600}
.att{margin-top:8px}.att img{max-width:200px;max-height:150px;border-radius:4px;margin:4px 4px 4px 0}
.eid{font-size:10px;color:#aaa;margin-top:8px;font-family:monospace}
.footer{margin-top:32px;padding-top:16px;border-top:1px solid #dee2e6;font-size:11px;color:#999;text-align:center}
.pbtn{position:fixed;bottom:30px;right:30px;background:#0d6efd;color:#fff;border:none;padding:14px 28px;border-radius:8px;font-size:15px;font-weight:600;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,.3)}
</style></head><body>
<h1>üìã Custody Documentation Log</h1>
<div class="sub">Prepared for: ${USER_NAME} | Generated: ${now} | ${positives.length} positive moments, ${incidents.length} incidents</div>
<div class="conf">‚ö†Ô∏è PRIVILEGED & CONFIDENTIAL ‚Äî Prepared for attorney review.</div>
<div class="summary"><h2>Summary</h2><div class="sg">
<div class="si"><div class="n">${S.entries.length}</div><div class="l">Total Entries</div></div>
<div class="si"><div class="n" style="color:#28a745">${positives.length}</div><div class="l">Positive Moments</div></div>
<div class="si"><div class="n" style="color:#dc3545">${incidents.length}</div><div class="l">Incidents</div></div>
<div class="si"><div class="n" style="color:#dc3545">${incidents.filter(e=>e.severity==='critical').length}</div><div class="l">Critical</div></div>
<div class="si"><div class="n">${S.entries.filter(e=>e.kidsThere).length}</div><div class="l">Kids Involved</div></div>
<div class="si"><div class="n">${S.entries.filter(e=>e.media&&e.media.length).length}</div><div class="l">W/ Attachments</div></div>
</div></div>`;

  // Positive section first
  if (positives.length) {
    h += `<h2 class="section-header sh-pos">üíö Positive Parenting & Co-Parenting (${positives.length})</h2>`;
    h += renderReportEntries(positives, true);
  }

  // Incidents section
  if (incidents.length) {
    h += `<h2 class="section-header sh-inc">üìã Documented Incidents (${incidents.length})</h2>`;
    h += renderReportEntries(incidents, false);
  }

  h += `<div class="footer"><p>Generated by CustodyLog for ${USER_NAME} | ${now}</p><p>Entries recorded by user at times indicated. Each entry shows both the event date and the date it was logged.</p></div>
  <button class="pbtn no-print" onclick="window.print()">üñ®Ô∏è Print / Save as PDF</button></body></html>`;
  downloadBlob(h,'text/html',`CustodyLog_${USER_NAME}_Report_${new Date().toISOString().slice(0,10)}.html`);
  toast('Report downloaded');
}

function renderReportEntries(entries, isPos) {
  let h = '';
  const months = {};
  entries.forEach(e => { const m = e.date.slice(0,7); if (!months[m]) months[m] = []; months[m].push(e); });

  for (const [month, ents] of Object.entries(months)) {
    const d = new Date(month+'-01');
    h += `<h2 class="monthh">${d.toLocaleDateString('en-US',{year:'numeric',month:'long'})} (${ents.length})</h2>`;
    ents.forEach(e => {
      const c = findCat(e.category, e.type);
      const createdDate = new Date(e.createdAt).toLocaleString();
      const datesMatch = e.createdAt && e.date === e.createdAt.slice(0,10);
      h += `<div class="entry${isPos?' entry-pos':''}">
        <div class="eh"><div class="ec">${c?c.icon+' '+c.label:e.category}</div><span class="es s-${isPos?'positive':e.severity}">${isPos?'Positive':e.severity}</span></div>
        <div class="ed">üìÖ ${fmtDate(e.date)} at ${fmtTime(e.time)}</div>
        <div class="edesc">${escH(e.description)}</div>
        <div class="edet">
          ${e.location?`<span>üìç ${escH(e.location)}</span>`:''}
          ${e.witnesses && !isPos?`<span>üëÅÔ∏è ${escH(e.witnesses)}</span>`:''}
          ${e.kidsThere?`<span${isPos?'':' class="cf"'}>${isPos?'üë®‚Äçüëß‚Äçüë¶':'‚ö†Ô∏è'} Children${e.kidsNames?' ‚Äî '+escH(e.kidsNames):''}</span>`:''}
        </div>
        ${e.media&&e.media.length?`<div class="att">${e.media.filter(m=>m.type.startsWith('image/')).map(m=>`<img src="${m.data}">`).join('')}
          ${e.media.filter(m=>!m.type.startsWith('image/')).length?`<div style="margin-top:6px">${e.media.filter(m=>!m.type.startsWith('image/')).map(m=>`<div style="display:inline-block;padding:6px 10px;background:#e9ecef;border-radius:4px;font-size:12px;margin:4px 4px 0 0;">üìé ${escH(m.name)} <span style="color:#6c757d;font-style:italic">‚Äî file available in Media Bundle export (Entry ${e.id})</span></div>`).join('')}</div>`:''}
        </div>`:''}
        <div class="eid">ID: ${e.id} | Logged: ${createdDate}${!datesMatch?' (backdated entry)':''}</div>
      </div>`;
    });
  }
  return h;
}

function exportCSV() {
  if (!S.entries.length) { toast('No entries'); return; }
  const sorted = [...S.entries].sort((a,b)=>new Date(a.date+'T'+a.time)-new Date(b.date+'T'+b.time));
  const hdr = ['Type','Date','Time','Category','Severity','Description','Location','Witnesses','Children Present','Children Names','Attachments','Entry ID','Created','Updated'];
  const rows = sorted.map(e => [isPositive(e)?'Positive':'Incident',e.date,e.time,catLabel(e.category,e.type),isPositive(e)?'Positive':e.severity,
    '"'+(e.description||'').replace(/"/g,'""')+'"',
    '"'+(e.location||'').replace(/"/g,'""')+'"',
    '"'+(e.witnesses||'').replace(/"/g,'""')+'"',
    e.kidsThere?'Yes':'No','"'+(e.kidsNames||'').replace(/"/g,'""')+'"',
    (e.media||[]).length, e.id, e.createdAt, e.updatedAt||'']);
  downloadBlob([hdr.join(','),...rows.map(r=>r.join(','))].join('\n'),'text/csv',`CustodyLog_${USER_NAME}_${new Date().toISOString().slice(0,10)}.csv`);
  toast('CSV downloaded');
}

function exportJSON() {
  if (!S.entries.length) { toast('No entries'); return; }
  downloadBlob(JSON.stringify({v:3,user:USER_NAME,date:new Date().toISOString(),entries:S.entries},null,2),'application/json',`CustodyLog_${USER_NAME}_Backup_${new Date().toISOString().slice(0,10)}.json`);
  toast('Backup downloaded');
}

function exportMediaZip() {
  const files = [];
  const sorted = [...S.entries].sort((a,b)=>new Date(a.date+'T'+a.time)-new Date(b.date+'T'+b.time));
  sorted.forEach(e => {
    if (!e.media || !e.media.length) return;
    const type = isPositive(e) ? 'Positive' : 'Incident';
    const folder = `${e.date}_${type}_${e.id}`;
    e.media.forEach((m, i) => {
      const ext = m.name.split('.').pop() || 'bin';
      const fname = `${folder}/${(i+1).toString().padStart(2,'0')}_${m.name}`;
      const b64 = m.data.split(',')[1];
      if (!b64) return;
      const bin = atob(b64);
      const bytes = new Uint8Array(bin.length);
      for (let j = 0; j < bin.length; j++) bytes[j] = bin.charCodeAt(j);
      files.push({ name: fname, data: bytes });
    });
  });
  if (!files.length) { toast('No media files to export', true); return; }
  // Build index
  let idx = `MEDIA BUNDLE INDEX\n${'='.repeat(50)}\nGenerated: ${new Date().toLocaleString()}\nUser: ${USER_NAME}\nTotal files: ${files.length}\n\n`;
  sorted.forEach(e => {
    if (!e.media || !e.media.length) return;
    const type = isPositive(e) ? 'Positive' : 'Incident';
    const c = findCat(e.category, e.type);
    idx += `Entry ID: ${e.id}\n`;
    idx += `  Type: ${type}\n`;
    idx += `  Date: ${e.date} ${e.time}\n`;
    idx += `  Category: ${c ? c.label : e.category}\n`;
    idx += `  Description: ${(e.description||'').slice(0,120)}${(e.description||'').length>120?'...':''}\n`;
    idx += `  Files: ${e.media.map(m=>m.name).join(', ')}\n\n`;
  });
  const idxBytes = new TextEncoder().encode(idx);
  files.unshift({ name: '_INDEX.txt', data: idxBytes });
  // Build zip
  const zip = buildZip(files);
  downloadBlob(zip, 'application/zip', `CustodyLog_${USER_NAME}_Media_${new Date().toISOString().slice(0,10)}.zip`);
  toast(`Media bundle: ${files.length - 1} files`);
}

function buildZip(files) {
  const localHeaders = [];
  const centralHeaders = [];
  let offset = 0;
  files.forEach(f => {
    const nameBytes = new TextEncoder().encode(f.name);
    const crc = crc32(f.data);
    // Local file header
    const lh = new Uint8Array(30 + nameBytes.length);
    const lv = new DataView(lh.buffer);
    lv.setUint32(0, 0x04034b50, true); // sig
    lv.setUint16(4, 20, true); // version needed
    lv.setUint16(6, 0, true); // flags
    lv.setUint16(8, 0, true); // compression (STORED)
    lv.setUint16(10, 0, true); // mod time
    lv.setUint16(12, 0, true); // mod date
    lv.setUint32(14, crc, true);
    lv.setUint32(18, f.data.length, true); // compressed
    lv.setUint32(22, f.data.length, true); // uncompressed
    lv.setUint16(26, nameBytes.length, true);
    lv.setUint16(28, 0, true); // extra length
    lh.set(nameBytes, 30);
    localHeaders.push({ header: lh, data: f.data, offset, nameBytes, crc, size: f.data.length });
    offset += lh.length + f.data.length;
    // Central directory header
    const ch = new Uint8Array(46 + nameBytes.length);
    const cv = new DataView(ch.buffer);
    cv.setUint32(0, 0x02014b50, true);
    cv.setUint16(4, 20, true); // version made by
    cv.setUint16(6, 20, true); // version needed
    cv.setUint16(8, 0, true);
    cv.setUint16(10, 0, true); // compression
    cv.setUint16(12, 0, true);
    cv.setUint16(14, 0, true);
    cv.setUint32(16, crc, true);
    cv.setUint32(20, f.data.length, true);
    cv.setUint32(24, f.data.length, true);
    cv.setUint16(28, nameBytes.length, true);
    cv.setUint16(30, 0, true);
    cv.setUint16(32, 0, true);
    cv.setUint16(34, 0, true);
    cv.setUint16(36, 0, true);
    cv.setUint32(38, 0, true);
    cv.setUint32(42, localHeaders[localHeaders.length-1].offset, true);
    ch.set(nameBytes, 46);
    centralHeaders.push(ch);
  });
  const cdOffset = offset;
  let cdSize = 0;
  centralHeaders.forEach(c => cdSize += c.length);
  const eocd = new Uint8Array(22);
  const ev = new DataView(eocd.buffer);
  ev.setUint32(0, 0x06054b50, true);
  ev.setUint16(4, 0, true);
  ev.setUint16(6, 0, true);
  ev.setUint16(8, files.length, true);
  ev.setUint16(10, files.length, true);
  ev.setUint32(12, cdSize, true);
  ev.setUint32(16, cdOffset, true);
  ev.setUint16(20, 0, true);
  const totalSize = offset + cdSize + 22;
  const result = new Uint8Array(totalSize);
  let pos = 0;
  localHeaders.forEach(l => { result.set(l.header, pos); pos += l.header.length; result.set(l.data, pos); pos += l.data.length; });
  centralHeaders.forEach(c => { result.set(c, pos); pos += c.length; });
  result.set(eocd, pos);
  return result;
}

function crc32(data) {
  let crc = 0xFFFFFFFF;
  for (let i = 0; i < data.length; i++) {
    crc ^= data[i];
    for (let j = 0; j < 8; j++) crc = (crc >>> 1) ^ (crc & 1 ? 0xEDB88320 : 0);
  }
  return (crc ^ 0xFFFFFFFF) >>> 0;
}

function importJSON() {
  const el = document.getElementById('importInput');
  el.value = '';
  el.onchange = (ev) => {
    const f = ev.target.files[0]; if (!f) return;
    const r = new FileReader();
    r.onload = (e) => {
      try {
        const d = JSON.parse(e.target.result);
        if (d.entries && Array.isArray(d.entries)) {
          const ids = new Set(S.entries.map(x=>x.id));
          let added = 0;
          d.entries.forEach(entry => {
            if (!ids.has(entry.id)) {
              // Ensure type field exists for backward compat
              if (!entry.type) entry.type = 'incident';
              S.entries.push(entry); added++;
            }
          });
          LS.save(S.entries); toast(`Imported ${added} entries`); render();
        } else toast('Invalid file', true);
      } catch { toast('Could not read file', true); }
    };
    r.readAsText(f);
  };
  el.click();
}

// Helpers
function genId() { return Date.now().toString(36)+Math.random().toString(36).slice(2,7); }
function truncate(s,n) { return s.length>n ? s.slice(0,n)+'‚Ä¶' : s; }
function esc(s) { return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function escH(s) { const d=document.createElement('div');d.textContent=s;return d.innerHTML; }
function nowDT() { const d=new Date(); return {date:d.toISOString().split('T')[0],time:d.toTimeString().slice(0,5)}; }
function fmtDate(d) { try{return new Date(d+'T00:00:00').toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric',year:'numeric'});}catch{return d;} }
function fmtTime(t) { try{const[h,m]=t.split(':');const hr=parseInt(h);return`${hr>12?hr-12:hr||12}:${m} ${hr>=12?'PM':'AM'}`;}catch{return t;} }
function downloadBlob(c,t,f) { const b=new Blob([c],{type:t}),u=URL.createObjectURL(b),a=document.createElement('a');a.href=u;a.download=f;a.click();URL.revokeObjectURL(u); }
function toast(m,warn) { const t=document.getElementById('toast');t.textContent=m;t.className='toast show'+(warn?' warn':'');setTimeout(()=>t.className='toast',2500); }

// Boot
boot();
if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js').catch(()=>{});
</script>
</body>
</html>
